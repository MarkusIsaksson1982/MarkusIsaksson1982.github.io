<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bowlby+One+SC&family=Permanent+Marker&family=Chewy&display=swap');

  :root {
    --simpsons-yellow: #FED41D;
    --simpsons-yellow-dark: #E8B800;
    --sky-blue: #4AA8D8;
    --sky-blue-deep: #2B7AAF;
    --cloud-white: #F0F4F8;
    --ground-green: #4CAF50;
    --ground-dark: #2E7D32;
    --road-gray: #666;
    --building-beige: #D4A574;
    --building-pink: #E8A0BF;
    --building-blue: #7EB8D4;
    --school-red: #C0392B;
    --plant-gray: #78909C;
    --plant-tower: #F9A825;
    --skin-generic: #FFD89E;
    --npc-skin: #FDBCB4;
    --night-bg: #1a1a3e;
    --couch-brown: #8B4513;
    --couch-light: #A0522D;
    --floor-color: #DEB887;
    --wall-color: #E8D5B7;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    overflow: hidden;
    font-family: 'Chewy', cursive;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #stage {
    width: 100vw;
    height: 100vh;
    position: relative;
    overflow: hidden;
    background: #000;
  }

  /* ===== SCENE SYSTEM ===== */
  .scene {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    overflow: hidden;
  }
  .scene.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* ===== SCENE 1: CLOUDS & TITLE ===== */
  #scene-title {
    background: linear-gradient(180deg, #87CEEB 0%, var(--sky-blue) 40%, var(--sky-blue-deep) 100%);
  }

  .cloud-layer {
    position: absolute;
    width: 200%;
    height: 100%;
    top: 0;
    left: -50%;
  }

  .cloud {
    position: absolute;
    background: var(--cloud-white);
    border-radius: 50%;
    filter: blur(2px);
    opacity: 0.9;
  }

  .cloud::before, .cloud::after {
    content: '';
    position: absolute;
    background: inherit;
    border-radius: 50%;
  }

  .cloud-1 { width: 18vw; height: 6vw; top: 10%; left: 10%; }
  .cloud-1::before { width: 60%; height: 120%; bottom: 30%; left: 15%; }
  .cloud-1::after { width: 45%; height: 100%; bottom: 20%; right: 15%; }

  .cloud-2 { width: 22vw; height: 7vw; top: 25%; left: 55%; }
  .cloud-2::before { width: 55%; height: 130%; bottom: 35%; left: 20%; }
  .cloud-2::after { width: 40%; height: 110%; bottom: 25%; right: 10%; }

  .cloud-3 { width: 15vw; height: 5vw; top: 15%; left: 35%; }
  .cloud-3::before { width: 65%; height: 125%; bottom: 30%; left: 10%; }
  .cloud-3::after { width: 50%; height: 105%; bottom: 15%; right: 15%; }

  .cloud-4 { width: 20vw; height: 6vw; top: 5%; left: 75%; }
  .cloud-4::before { width: 50%; height: 120%; bottom: 25%; left: 25%; }
  .cloud-4::after { width: 45%; height: 95%; bottom: 20%; right: 20%; }

  .clouds-parting-left {
    animation: cloudsPartLeft 2.5s ease-in-out forwards;
  }
  .clouds-parting-right {
    animation: cloudsPartRight 2.5s ease-in-out forwards;
  }

  @keyframes cloudsPartLeft {
    0% { transform: translateX(0); }
    100% { transform: translateX(-60%); opacity: 0.3; }
  }
  @keyframes cloudsPartRight {
    0% { transform: translateX(0); }
    100% { transform: translateX(60%); opacity: 0.3; }
  }

  .title-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Bowlby One SC', cursive;
    font-size: clamp(2rem, 8vw, 7rem);
    color: var(--simpsons-yellow);
    text-shadow:
      3px 3px 0 #C8960F,
      6px 6px 0 rgba(0,0,0,0.3),
      0 0 40px rgba(254,212,29,0.4);
    letter-spacing: 0.05em;
    white-space: nowrap;
    z-index: 10;
    opacity: 0;
  }

  .title-text.animate-in {
    animation: titleZoomIn 1.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.8s forwards;
  }

  @keyframes titleZoomIn {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-5deg); opacity: 0; }
    60% { transform: translate(-50%, -50%) scale(1.15) rotate(1deg); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
  }

  .title-subtitle {
    position: absolute;
    top: 62%;
    left: 50%;
    transform: translate(-50%, 0);
    font-family: 'Permanent Marker', cursive;
    font-size: clamp(0.7rem, 2vw, 1.5rem);
    color: white;
    opacity: 0;
    letter-spacing: 0.15em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    z-index: 10;
  }
  .title-subtitle.animate-in {
    animation: fadeUp 1s ease 2.2s forwards;
  }

  @keyframes fadeUp {
    0% { opacity: 0; transform: translate(-50%, 20px); }
    100% { opacity: 1; transform: translate(-50%, 0); }
  }

  /* ===== SCENE 2: FLYOVER — SPRINGFIELD PANORAMA ===== */
  #scene-flyover {
    background: linear-gradient(180deg, #87CEEB 0%, var(--sky-blue) 60%, var(--ground-green) 60%, var(--ground-dark) 100%);
  }

  .panorama-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 300%;
    height: 60%;
    animation: panoramaScroll 5s linear forwards;
  }

  @keyframes panoramaScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-66%); }
  }

  .building {
    position: absolute;
    bottom: 0;
    border-radius: 4px 4px 0 0;
  }

  .building-window {
    position: absolute;
    width: 18%;
    height: 10%;
    background: rgba(255,255,200,0.8);
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 1px;
  }

  /* Nuclear Plant Towers */
  .nuclear-tower {
    position: absolute;
    bottom: 0;
    width: 5%;
    background: var(--plant-gray);
    clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
  }
  .nuclear-tower::after {
    content: '';
    position: absolute;
    top: -15%;
    left: 15%;
    width: 70%;
    height: 20%;
    background: #ddd;
    border-radius: 50% 50% 0 0;
  }

  .smoke-puff {
    position: absolute;
    width: 3vw;
    height: 3vw;
    background: rgba(220,220,220,0.7);
    border-radius: 50%;
    animation: smokeRise 3s ease-out infinite;
  }

  @keyframes smokeRise {
    0% { transform: translateY(0) scale(1); opacity: 0.7; }
    100% { transform: translateY(-8vw) scale(2.5); opacity: 0; }
  }

  .flyover-sun {
    position: absolute;
    top: 8%;
    right: 15%;
    width: 8vw;
    height: 8vw;
    background: radial-gradient(circle, #FFF176 30%, #FDD835 60%, transparent 70%);
    border-radius: 50%;
    box-shadow: 0 0 60px rgba(253,216,53,0.5);
  }

  /* ===== SCENE 3: BART — CHALKBOARD ===== */
  #scene-bart {
    background: var(--school-red);
  }

  .classroom {
    position: absolute;
    inset: 5%;
    background: #F5E6C8;
    border: 4px solid #5D4037;
    border-radius: 4px;
    overflow: hidden;
  }

  .chalkboard {
    position: absolute;
    top: 8%;
    left: 10%;
    width: 55%;
    height: 55%;
    background: #2E5339;
    border: 8px solid #8D6E63;
    border-radius: 3px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.3), 4px 4px 10px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10%;
  }

  .chalk-text {
    color: rgba(255,255,255,0.85);
    font-family: 'Permanent Marker', cursive;
    font-size: clamp(0.5rem, 1.8vw, 1.4rem);
    line-height: 1.6;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.2);
    opacity: 0;
  }

  .chalk-text.writing {
    animation: chalkWrite 2s steps(40) forwards;
  }

  @keyframes chalkWrite {
    0% { opacity: 1; width: 0; overflow: hidden; white-space: nowrap; }
    100% { opacity: 1; width: 100%; overflow: hidden; white-space: nowrap; }
  }

  /* ===== CHARACTER SYSTEM ===== */
  /*
    MAIN CHARACTERS (Set B): These have class "main-char" and a data-character attribute.
    They are designed with larger, more detailed placeholder silhouettes
    that can be replaced with custom artwork.

    NPCs: These have class "npc-char" and are simpler, meant to stay mostly as-is.
  */

  .character {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .char-body {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Generic head */
  .char-head {
    width: var(--head-size, 4vw);
    height: var(--head-size, 4vw);
    border-radius: 50%;
    position: relative;
    z-index: 2;
  }

  .char-torso {
    width: calc(var(--head-size, 4vw) * 1.1);
    height: calc(var(--head-size, 4vw) * 1.4);
    border-radius: 30% 30% 5% 5%;
    margin-top: calc(var(--head-size, 4vw) * -0.15);
    z-index: 1;
  }

  .char-legs {
    display: flex;
    gap: 3px;
    margin-top: -2px;
  }
  .char-leg {
    width: calc(var(--head-size, 4vw) * 0.35);
    height: calc(var(--head-size, 4vw) * 1.2);
    border-radius: 3px 3px 5px 5px;
  }

  /* Eyes for characters */
  .char-eyes {
    position: absolute;
    top: 35%;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15%;
  }
  .char-eye {
    width: calc(var(--head-size, 4vw) * 0.22);
    height: calc(var(--head-size, 4vw) * 0.28);
    background: white;
    border-radius: 50%;
    position: relative;
    border: 1.5px solid #333;
  }
  .char-pupil {
    position: absolute;
    width: 45%;
    height: 45%;
    background: #111;
    border-radius: 50%;
    top: 30%;
    left: 35%;
  }

  /* MAIN CHARACTERS — larger, more detailed, with image swap slots */
  .main-char {
    --head-size: 5.5vw;
  }
  .main-char .char-head { border: 2px solid rgba(0,0,0,0.15); }
  .main-char .char-image-slot {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    overflow: hidden;
    z-index: 5;
    display: none; /* shown when custom image provided */
  }
  .main-char .char-image-slot img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .main-char .char-label {
    font-family: 'Chewy', cursive;
    font-size: clamp(0.5rem, 1.2vw, 1rem);
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    margin-top: 4px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .main-char.show-label .char-label { opacity: 1; }

  /* NPC CHARACTERS — simpler, smaller */
  .npc-char {
    --head-size: 2.8vw;
    opacity: 0.85;
  }

  /* ===== CHARACTER COLORS (MATCHED TO IMAGE) ===== */
  
  /* BART - Young boy: white t-shirt, blue shorts */
  [data-character="bart"] .char-head { background: var(--simpsons-yellow); }
  [data-character="bart"] .char-torso { background: #F5F5F5; }
  [data-character="bart"] .char-legs .char-leg { background: #4A7BA7; }
  [data-character="bart"] .char-spikes {
    position: absolute;
    top: -30%;
    left: 5%;
    width: 90%;
    height: 40%;
    z-index: 3;
  }

  /* HOMER - Dad: beige shirt, blue jeans, baseball cap, goatee */
  [data-character="homer"] .char-head { background: var(--simpsons-yellow); }
  [data-character="homer"] .char-torso { background: #E8DCC8; }
  [data-character="homer"] .char-legs .char-leg { background: #4169E1; }
  
  /* Homer's baseball cap */
  [data-character="homer"] .char-cap {
    position: absolute;
    top: -25%;
    left: 5%;
    width: 90%;
    height: 35%;
    background: #2C2C2C;
    border-radius: 50% 50% 20% 20%;
    z-index: 3;
  }
  [data-character="homer"] .char-cap::before {
    content: '';
    position: absolute;
    bottom: -15%;
    left: 50%;
    transform: translateX(-50%);
    width: 110%;
    height: 20%;
    background: #2C2C2C;
    border-radius: 50%;
  }
  [data-character="homer"] .char-cap::after {
    content: '';
    position: absolute;
    bottom: -8%;
    left: -15%;
    width: 60%;
    height: 12%;
    background: #2C2C2C;
    border-radius: 3px;
  }
  
  /* Homer's goatee */
  [data-character="homer"] .char-goatee {
    position: absolute;
    bottom: 5%;
    left: 35%;
    width: 30%;
    height: 15%;
    background: #5C4033;
    border-radius: 0 0 50% 50%;
    z-index: 4;
  }

  /* MARGE - Grandma: pink floral top, light blue capris, glasses, gray hair bun */
  [data-character="marge"] .char-head { background: var(--simpsons-yellow); }
  [data-character="marge"] .char-torso { background: #F5B6D4; }
  [data-character="marge"] .char-legs .char-leg { background: #8DBECD; }
  
  /* Marge's hair bun */
  [data-character="marge"] .char-hair-tall {
    position: absolute;
    top: -50%;
    left: 20%;
    width: 60%;
    height: 60%;
    background: #B8B8B8;
    border-radius: 50%;
    z-index: 3;
  }
  [data-character="marge"] .char-hair-tall::before {
    content: '';
    position: absolute;
    bottom: -10%;
    left: 10%;
    width: 80%;
    height: 25%;
    background: #B8B8B8;
    border-radius: 50%;
  }
  [data-character="marge"] .char-hair-tall::after {
    content: '';
    position: absolute;
    top: 20%;
    left: -5%;
    width: 30%;
    height: 40%;
    background: #F5C4D6;
    border-radius: 50%;
  }
  
  /* Marge's glasses */
  [data-character="marge"] .char-glasses {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translateX(-50%);
    width: 85%;
    height: 25%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8%;
    z-index: 5;
  }
  [data-character="marge"] .char-glasses::before,
  [data-character="marge"] .char-glasses::after {
    content: '';
    width: 42%;
    height: 100%;
    background: rgba(255,255,255,0.3);
    border: 2px solid #333;
    border-radius: 50%;
    box-shadow: inset 0 0 4px rgba(255,255,255,0.5);
  }

  /* RELATIVE 1 - Guy in polo: dark polo shirt, tan pants */
  [data-character="relative1"] .char-head { background: var(--simpsons-yellow); }
  [data-character="relative1"] .char-torso { background: #4A5568; }
  [data-character="relative1"] .char-legs .char-leg { background: #C19A6B; }
  
  /* Relative 1's brown hair */
  [data-character="relative1"] .char-hair {
    position: absolute;
    top: -8%;
    left: 8%;
    width: 84%;
    height: 30%;
    background: #5C4033;
    border-radius: 50% 50% 0 0;
    z-index: 3;
  }

  /* RELATIVE 2 - Guy in dark shirt: black t-shirt, dark pants */
  [data-character="relative2"] .char-head { background: var(--simpsons-yellow); }
  [data-character="relative2"] .char-torso { background: #2D3748; }
  [data-character="relative2"] .char-legs .char-leg { background: #1A202C; }
  
  /* Relative 2's brown hair */
  [data-character="relative2"] .char-hair {
    position: absolute;
    top: -8%;
    left: 8%;
    width: 84%;
    height: 30%;
    background: #5C4033;
    border-radius: 50% 50% 0 0;
    z-index: 3;
  }

  /* ===== SCENE 4: HOMER AT WORK ===== */
  #scene-homer {
    background: linear-gradient(180deg, var(--plant-gray) 0%, #546E7A 100%);
  }

  .plant-interior {
    position: absolute;
    inset: 0;
    background:
      linear-gradient(180deg, #78909C 0%, #607D8B 40%, #B0BEC5 40%, #CFD8DC 100%);
  }

  .control-panel {
    position: absolute;
    bottom: 15%;
    left: 10%;
    width: 45%;
    height: 35%;
    background: #455A64;
    border: 3px solid #37474F;
    border-radius: 5px;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
  }

  .panel-light {
    position: absolute;
    width: 1.5vw;
    height: 1.5vw;
    border-radius: 50%;
    border: 2px solid #333;
  }

  .panel-light.green { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
  .panel-light.red { background: #F44336; box-shadow: 0 0 8px #F44336; }
  .panel-light.yellow { background: #FFC107; box-shadow: 0 0 8px #FFC107; }

  .panel-light.blink {
    animation: blinkLight 1s ease infinite alternate;
  }
  @keyframes blinkLight {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  .radiation-symbol {
    position: absolute;
    top: 5%;
    right: 8%;
    width: 8vw;
    height: 8vw;
    opacity: 0.15;
  }

  .whistle-effect {
    position: absolute;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Bowlby One SC', cursive;
    font-size: clamp(1rem, 3vw, 2.5rem);
    color: var(--simpsons-yellow);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    opacity: 0;
  }
  .whistle-effect.show {
    animation: whistlePop 0.8s ease forwards;
  }
  @keyframes whistlePop {
    0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
    50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
    100% { opacity: 1; transform: translateX(-50%) scale(1); }
  }

  /* ===== SCENE 5: MARGE — GROCERY ===== */
  #scene-marge {
    background: #F8F0E0;
  }

  .store-interior {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, #FFFFFF 0%, #F5F5DC 100%);
  }

  .store-shelf {
    position: absolute;
    height: 60%;
    width: 8%;
    background: #8D6E63;
    top: 10%;
    border-radius: 2px;
  }
  .shelf-item {
    position: absolute;
    width: 70%;
    height: 12%;
    left: 15%;
    border-radius: 3px;
  }

  .checkout-belt {
    position: absolute;
    bottom: 18%;
    left: 30%;
    width: 50%;
    height: 5%;
    background: #999;
    border: 2px solid #666;
    border-radius: 2px;
  }

  .grocery-item {
    position: absolute;
    width: 3vw;
    height: 3vw;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.15);
  }

  /* ===== SCENE 6: RELATIVE 1 — MUSIC/ACTIVITY ===== */
  #scene-relative1 {
    background: linear-gradient(180deg, #1a1a3e 0%, #2d2d6b 100%);
  }

  .spotlight {
    position: absolute;
    width: 30vw;
    height: 80vh;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    background: radial-gradient(ellipse at top, rgba(255,255,200,0.3) 0%, transparent 70%);
    clip-path: polygon(35% 0%, 65% 0%, 100% 100%, 0% 100%);
  }

  .music-notes {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .note {
    position: absolute;
    font-size: clamp(1rem, 2.5vw, 2rem);
    opacity: 0;
    animation: noteFloat 3s ease-out forwards;
  }

  @keyframes noteFloat {
    0% { opacity: 0; transform: translateY(0) rotate(0deg); }
    20% { opacity: 0.8; }
    100% { opacity: 0; transform: translateY(-30vh) rotate(20deg) translateX(3vw); }
  }

  /* ===== SCENE 7: RELATIVE 2 — SPORTS/ACTIVITY ===== */
  #scene-relative2 {
    background: linear-gradient(180deg, #87CEEB 0%, var(--sky-blue) 50%, var(--ground-green) 50%, var(--ground-dark) 100%);
  }

  .sports-field {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: repeating-linear-gradient(
      90deg,
      var(--ground-green) 0px,
      var(--ground-green) 10%,
      #45A049 10%,
      #45A049 20%
    );
  }

  .field-lines {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: repeating-linear-gradient(
      90deg,
      transparent 0px,
      transparent 9.8%,
      rgba(255,255,255,0.3) 9.8%,
      rgba(255,255,255,0.3) 10.2%
    );
  }

  /* ===== SCENE 8: DRIVE HOME — TOWNSPEOPLE ===== */
  #scene-drive {
    background: linear-gradient(180deg, #E8A75C 0%, #F4C67A 40%, var(--road-gray) 40%, #555 42%, var(--ground-green) 42%, var(--ground-dark) 100%);
  }

  .road-lines {
    position: absolute;
    top: 40%;
    left: 0;
    width: 100%;
    height: 2%;
    background: repeating-linear-gradient(
      90deg,
      var(--simpsons-yellow) 0px,
      var(--simpsons-yellow) 30px,
      transparent 30px,
      transparent 60px
    );
    animation: roadScroll 0.5s linear infinite;
  }
  @keyframes roadScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-60px); }
  }

  .car {
    position: absolute;
    bottom: 52%;
    width: 14vw;
    height: 6vw;
  }

  .car-body {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 55%;
    background: #E8A0BF;
    border-radius: 10px 10px 5px 5px;
    border: 2px solid rgba(0,0,0,0.2);
  }

  .car-top {
    position: absolute;
    bottom: 45%;
    left: 15%;
    width: 55%;
    height: 55%;
    background: #E8A0BF;
    border-radius: 10px 10px 3px 3px;
    border: 2px solid rgba(0,0,0,0.2);
    border-bottom: none;
  }

  .car-window {
    position: absolute;
    top: 15%;
    width: 42%;
    height: 65%;
    background: rgba(135,206,235,0.7);
    border: 1.5px solid rgba(0,0,0,0.2);
  }
  .car-window.front { left: 52%; border-radius: 3px 8px 3px 3px; }
  .car-window.back { left: 5%; border-radius: 8px 3px 3px 3px; }

  .car-wheel {
    position: absolute;
    bottom: -15%;
    width: 18%;
    height: 35%;
    background: #333;
    border-radius: 50%;
    border: 2px solid #555;
  }
  .car-wheel.front-wheel { right: 10%; }
  .car-wheel.back-wheel { left: 10%; }
  .car-wheel::after {
    content: '';
    position: absolute;
    inset: 25%;
    background: #888;
    border-radius: 50%;
  }

  .npc-townsperson {
    position: absolute;
    bottom: 45%;
  }

  /* ===== SCENE 9: COUCH GAG ===== */
  #scene-couch {
    background: var(--wall-color);
  }

  .living-room {
    position: absolute;
    inset: 0;
    background: var(--wall-color);
  }

  .floor-area {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 35%;
    background: var(--floor-color);
    border-top: 4px solid #A0896C;
  }

  .couch {
    position: absolute;
    bottom: 35%;
    left: 50%;
    transform: translateX(-50%);
    width: 50vw;
    height: 18vw;
  }

  .couch-back {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 55%;
    background: var(--couch-brown);
    border-radius: 12px 12px 0 0;
    border: 3px solid #6D3A0A;
  }

  .couch-seat {
    position: absolute;
    bottom: 0;
    left: -3%;
    width: 106%;
    height: 50%;
    background: var(--couch-light);
    border-radius: 8px;
    border: 3px solid #6D3A0A;
  }

  .couch-arm {
    position: absolute;
    bottom: 0;
    width: 8%;
    height: 75%;
    background: var(--couch-brown);
    border: 3px solid #6D3A0A;
    border-radius: 8px 8px 5px 5px;
    z-index: 5;
  }
  .couch-arm.left { left: -5%; }
  .couch-arm.right { right: -5%; }

  .tv-painting {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 15vw;
    height: 10vw;
    border: 6px solid #8D6E63;
    background: linear-gradient(135deg, #87CEEB 0%, #87CEEB 60%, #4CAF50 60%, #388E3C 100%);
    border-radius: 3px;
    box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
  }

  .lamp {
    position: absolute;
    bottom: 35%;
  }
  .lamp-shade {
    width: 5vw;
    height: 4vw;
    background: #F0E68C;
    clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
    border: 2px solid #DAC663;
  }
  .lamp-stand {
    width: 1vw;
    height: 6vw;
    background: #8D6E63;
    margin: 0 auto;
    border-radius: 2px;
  }
  .lamp-base {
    width: 4vw;
    height: 1vw;
    background: #8D6E63;
    border-radius: 3px;
    margin: 0 auto;
  }

  /* Couch characters arriving */
  .couch-character {
    position: absolute;
    bottom: 48%;
    opacity: 0;
    z-index: 10;
  }

  .couch-character.arrive {
    animation: couchArrive 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes couchArrive {
    0% { opacity: 0; transform: translateX(60vw); }
    70% { opacity: 1; transform: translateX(-5px); }
    100% { opacity: 1; transform: translateX(0); }
  }

  /* ===== SCENE 10: BIRTHDAY — RELATIVE 2 ===== */
  #scene-birthday {
    background: linear-gradient(180deg, #2C1654 0%, #3D1F70 50%, #4A2580 100%);
  }

  .birthday-room {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse at 50% 80%, rgba(255,200,50,0.08) 0%, transparent 60%),
      linear-gradient(180deg, #E8D5B7 0%, #F0E6D0 70%, var(--floor-color) 70%);
    overflow: hidden;
  }

  .birthday-floor {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 20%;
    background: linear-gradient(180deg, var(--floor-color), #C4A876);
    border-top: 3px solid #A0896C;
  }

  .birthday-banner {
    position: absolute;
    top: 6%;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.3vw;
    z-index: 20;
  }

  .birthday-banner span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: clamp(1.5rem, 3.2vw, 2.8rem);
    height: clamp(1.8rem, 3.8vw, 3.2rem);
    font-family: 'Bowlby One SC', cursive;
    font-size: clamp(0.7rem, 1.8vw, 1.5rem);
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    border-radius: 4px;
    opacity: 0;
  }

  .birthday-banner span:nth-child(odd) { background: #E74C3C; }
  .birthday-banner span:nth-child(even) { background: #3498DB; }
  .banner-space { width: 1.5vw !important; background: transparent !important; }

  .birthday-banner.reveal span {
    animation: bannerPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes bannerPop {
    0% { opacity: 0; transform: scale(0) rotate(-10deg); }
    100% { opacity: 1; transform: scale(1) rotate(0deg); }
  }

  /* Balloons */
  .balloon {
    position: absolute;
    width: clamp(2rem, 4vw, 3.5rem);
    height: clamp(2.5rem, 5vw, 4.5rem);
    border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
    opacity: 0;
    top: 15%;
    filter: saturate(1.2);
  }
  .balloon::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: 50%;
    width: 1px;
    height: 40%;
    background: rgba(0,0,0,0.2);
    transform: translateX(-50%);
  }
  .balloon.float-in {
    animation: balloonFloat 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  @keyframes balloonFloat {
    0% { opacity: 0; transform: translateY(50vh); }
    70% { opacity: 1; transform: translateY(-1vh); }
    100% { opacity: 0.9; transform: translateY(0); }
  }

  /* Cake */
  .birthday-table {
    position: absolute;
    bottom: 20%;
    left: 50%;
    transform: translateX(-50%);
    width: 20vw;
    height: 4vw;
    background: #8D6E63;
    border-radius: 5px;
    border: 2px solid #6D4C41;
    z-index: 10;
  }

  .birthday-cake {
    position: absolute;
    bottom: 90%;
    left: 50%;
    transform: translateX(-50%);
    width: 10vw;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .cake-layer {
    border-radius: 5px;
    border: 1.5px solid rgba(0,0,0,0.1);
  }
  .cake-bottom { width: 100%; height: 2.5vw; background: #F8BBD0; }
  .cake-middle { width: 78%; height: 2vw; background: #FFCCBC; margin-top: -2px; }
  .cake-top { width: 55%; height: 1.5vw; background: #FFF9C4; margin-top: -2px; border-radius: 5px 5px 3px 3px; }

  .cake-candles {
    position: absolute;
    top: -1.5vw;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.8vw;
  }
  .candle {
    width: 0.4vw;
    height: 1.5vw;
    border-radius: 2px;
  }
  .candle-flame {
    width: 0.6vw;
    height: 0.8vw;
    background: radial-gradient(ellipse, #FFF9C4 20%, #FF9800 60%, transparent 100%);
    border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
    margin: 0 auto;
    margin-top: -0.3vw;
    opacity: 0;
  }
  .candle-flame.lit {
    opacity: 1;
    animation: flicker 0.8s ease infinite alternate;
  }
  @keyframes flicker {
    0% { transform: scale(1) rotate(-3deg); opacity: 1; }
    50% { transform: scale(1.15) rotate(2deg); opacity: 0.85; }
    100% { transform: scale(0.95) rotate(-1deg); opacity: 1; }
  }

  .cake-glow {
    position: absolute;
    top: -3vw;
    left: 50%;
    transform: translateX(-50%);
    width: 14vw;
    height: 6vw;
    background: radial-gradient(ellipse, rgba(255,200,50,0.25) 0%, transparent 70%);
    opacity: 0;
    pointer-events: none;
  }
  .cake-glow.active { opacity: 1; }

  /* Present */
  .present-box {
    width: 2.5vw;
    height: 2.5vw;
    background: #E74C3C;
    border: 2px solid #C0392B;
    border-radius: 3px;
    position: relative;
  }
  .present-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 25%;
    height: 100%;
    background: #F1C40F;
  }
  .present-box::after {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    height: 25%;
    background: #F1C40F;
  }

  /* Party hat */
  .party-hat {
    position: absolute;
    top: -55%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: calc(var(--head-size, 4vw) * 0.3) solid transparent;
    border-right: calc(var(--head-size, 4vw) * 0.3) solid transparent;
    border-bottom: calc(var(--head-size, 4vw) * 0.55) solid;
    z-index: 10;
  }
  .party-hat::after {
    content: '✦';
    position: absolute;
    top: calc(var(--head-size, 4vw) * -0.15);
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(0.4rem, 0.8vw, 0.7rem);
    color: #F1C40F;
  }

  /* Confetti */
  .confetti-piece {
    position: absolute;
    width: 0.6vw;
    height: 0.6vw;
    opacity: 0;
    border-radius: 1px;
  }
  .confetti-piece.fall {
    animation: confettiFall 3s ease-out forwards;
  }
  @keyframes confettiFall {
    0% { opacity: 1; transform: translateY(-10vh) rotate(0deg); }
    100% { opacity: 0; transform: translateY(80vh) rotate(720deg); }
  }

  /* Birthday characters have a subtle bounce */
  .birthday-char {
    opacity: 0;
  }
  .birthday-char.appear {
    animation: bdayAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  @keyframes bdayAppear {
    0% { opacity: 0; transform: scale(0.5) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }

  /* ===== TRANSITION EFFECTS ===== */
  .wipe-transition {
    position: absolute;
    inset: 0;
    background: var(--simpsons-yellow);
    z-index: 100;
    transform: translateX(-100%);
    pointer-events: none;
  }
  .wipe-transition.active {
    animation: wipeAcross 0.6s ease-in-out forwards;
  }
  @keyframes wipeAcross {
    0% { transform: translateX(-100%); }
    45% { transform: translateX(0%); }
    55% { transform: translateX(0%); }
    100% { transform: translateX(100%); }
  }

  /* ===== CONTROLS ===== */
  .controls {
    position: fixed;
    bottom: 2vh;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    display: flex;
    gap: 12px;
    align-items: center;
    background: rgba(0,0,0,0.7);
    padding: 8px 20px;
    border-radius: 30px;
    backdrop-filter: blur(10px);
  }

  .controls button {
    font-family: 'Chewy', cursive;
    font-size: clamp(0.7rem, 1.2vw, 1rem);
    padding: 6px 18px;
    border: 2px solid var(--simpsons-yellow);
    background: transparent;
    color: var(--simpsons-yellow);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .controls button:hover {
    background: var(--simpsons-yellow);
    color: #333;
  }

  .scene-indicator {
    color: rgba(255,255,255,0.6);
    font-size: clamp(0.6rem, 1vw, 0.85rem);
    font-family: 'Chewy', cursive;
    letter-spacing: 0.05em;
  }

  /* ===== SKIP INTRO ===== */
  .skip-btn {
    position: fixed;
    top: 2vh;
    right: 2vw;
    z-index: 200;
    font-family: 'Chewy', cursive;
    font-size: clamp(0.7rem, 1vw, 0.9rem);
    padding: 6px 16px;
    background: rgba(0,0,0,0.5);
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .skip-btn:hover {
    background: rgba(0,0,0,0.8);
    color: white;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .main-char { --head-size: 8vw; }
    .npc-char { --head-size: 5vw; }
  }

  /* ===== NEW CONTROLS & TOOLTIPS ===== */
  #play-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
  }
  #play-btn {
    font-family: 'Bowlby One SC', cursive;
    font-size: 3rem;
    color: var(--simpsons-yellow);
    background: transparent;
    border: 4px solid var(--simpsons-yellow);
    padding: 1rem 3rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    text-shadow: 2px 2px 0 #000;
  }
  #play-btn:hover {
    background: var(--simpsons-yellow);
    color: #000;
    transform: scale(1.1);
  }

  /* Tooltips */
  .tooltip-target {
    position: relative;
    cursor: help;
  }
  .tooltip-box {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #333;
    padding: 8px;
    border-radius: 5px;
    width: max-content;
    max-width: 200px;
    text-align: center;
    font-family: 'Chewy', cursive;
    font-size: 1rem;
    color: #333;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 100;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
  }
  .tooltip-target:hover .tooltip-box {
    opacity: 1;
    pointer-events: auto;
  }
  .tooltip-box img {
    display: block;
    margin: 5px auto;
    max-width: 100%;
    border: 1px solid #ccc;
  }
  .tooltip-box a {
    display: block;
    margin-top: 4px;
    color: var(--sky-blue-deep);
    text-decoration: underline;
  }

  /* Props */
  .prop-recorder {
    position: absolute;
    top: 60%;
    left: 40%;
    width: 0.6vw;
    height: 3vw;
    background: #D7CCC8;
    border: 1px solid #5D4037;
    transform: rotate(-15deg);
    z-index: 10;
  }
  .prop-recorder::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 20%;
    width: 60%;
    height: 10%;
    background: #333;
  }

  .prop-vinyl-sleeve {
    position: absolute;
    bottom: 25%;
    right: -15%;
    width: 5vw;
    height: 5vw;
    background: #333;
    border: 1px solid #fff;
    transform: rotate(-10deg);
    z-index: 20;
    background-size: cover;
    background-image: url('vinyl-cover.jpg');
  }
  .prop-vinyl-record {
    position: absolute;
    top: 5%;
    right: 5%;
    width: 90%;
    height: 90%;
    background: #111;
    border-radius: 50%;
    transform: translateX(40%);
    z-index: -1;
    border: 1px solid #333;
  }
  .prop-vinyl-record::after {
    content: '';
    position: absolute;
    inset: 35%;
    background: #E74C3C;
    border-radius: 50%;
  }

  .prop-mug {
    position: absolute;
    bottom: 30%;
    left: -10%;
    width: 1.5vw;
    height: 1.8vw;
    background: white;
    border: 1px solid #ccc;
    border-radius: 2px;
    z-index: 20;
  }
  .prop-mug::after {
    content: '';
    position: absolute;
    top: 20%;
    left: -30%;
    width: 40%;
    height: 60%;
    border: 2px solid white;
    border-right: none;
    border-radius: 50% 0 0 50%;
  }

  /* Interaction State Control */
  .no-interaction .tooltip-target {
    pointer-events: none;
  }
  .no-interaction .tooltip-box {
    display: none;
  }

  /* New NPC Styles */
  [data-npc="burns"] .char-head { background: #D4E157; } /* Pale/Greenish */
  [data-npc="burns"] .char-torso { background: #00897B; } /* Teal Suit */
  [data-npc="burns"] .char-legs .char-leg { background: #004D40; }

  [data-npc="smithers"] .char-head { background: #8D6E63; } /* Brownish */
  [data-npc="smithers"] .char-torso { background: #795548; } /* Brown Suit */
  [data-npc="smithers"] .char-legs .char-leg { background: #3E2723; }
  [data-npc="smithers"] .char-glasses {
      position: absolute; top: 40%; left: 10%; width: 80%; height: 20%;
      border: 1px solid #333; background: rgba(255,255,255,0.3);
  }
</style>
</head>
<body>

<div id="stage">
  <!-- WIPE TRANSITION -->
  <div class="wipe-transition" id="wipe"></div>

  <!-- SCENE 1: TITLE -->
  <div class="scene active" id="scene-title">
    <div class="cloud-layer" id="clouds-left">
      <div class="cloud cloud-1"></div>
      <div class="cloud cloud-3"></div>
    </div>
    <div class="cloud-layer" id="clouds-right">
      <div class="cloud cloud-2"></div>
      <div class="cloud cloud-4"></div>
    </div>
    <div class="title-text" id="main-title">THE ISAKSSONS</div>
    <div class="title-subtitle" id="sub-title">A BIRTHDAY CELEBRATION</div>
  </div>

  <!-- SCENE 2: FLYOVER -->
  <div class="scene" id="scene-flyover">
    <div class="flyover-sun"></div>
    <div class="panorama-container" id="panorama">
      <!-- Buildings generated by JS -->
    </div>
    <div class="smoke-puff" style="top:12%;right:25%;animation-delay:0s;"></div>
    <div class="smoke-puff" style="top:8%;right:23%;animation-delay:1s;"></div>
    <div class="smoke-puff" style="top:15%;right:27%;animation-delay:2s;"></div>
  </div>

  <!-- SCENE 3: BART — CHALKBOARD -->
  <div class="scene" id="scene-bart">
    <div class="classroom">
      <div class="chalkboard">
        <div class="chalk-text" id="chalk-text">
          I WILL TAKE BREAKS<br>FROM PLAYING ROBLOX<br>I WILL TAKE BREAKS<br>FROM PLAYING ROBLOX
        </div>
      </div>

      <!-- BART (main character) -->
      <div class="character main-char" data-character="bart" style="right:15%;bottom:12%;" id="char-bart-classroom">
        <div class="char-body">
          <div class="char-head">
            <svg class="char-spikes" viewBox="0 0 50 25" style="position:absolute;top:-30%;left:5%;width:90%;z-index:3;">
              <polygon points="5,25 10,2 15,25 20,5 25,25 30,2 35,25 40,5 45,25" fill="var(--simpsons-yellow)" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
            </svg>
            <div class="char-eyes">
              <div class="char-eye"><div class="char-pupil"></div></div>
              <div class="char-eye"><div class="char-pupil"></div></div>
            </div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs">
            <div class="char-leg"></div>
            <div class="char-leg"></div>
          </div>
        </div>
        <div class="char-label">"NART"</div>
      </div>
    </div>
  </div>

  <!-- SCENE 4: HOMER — NUCLEAR PLANT -->
  <div class="scene" id="scene-homer">
    <div class="plant-interior">
      <div class="control-panel">
        <div class="panel-light green blink" style="top:15%;left:15%;"></div>
        <div class="panel-light red blink" style="top:15%;left:35%;animation-delay:0.5s;"></div>
        <div class="panel-light yellow blink" style="top:15%;left:55%;animation-delay:1s;"></div>
        <div class="panel-light green" style="top:15%;left:75%;"></div>
        <div class="panel-light red blink" style="top:45%;left:20%;animation-delay:0.3s;"></div>
        <div class="panel-light green blink" style="top:45%;left:45%;animation-delay:0.7s;"></div>
        <div class="panel-light yellow blink" style="top:45%;left:70%;animation-delay:1.2s;"></div>
        <div class="panel-light red" style="top:70%;left:25%;"></div>
        <div class="panel-light green blink" style="top:70%;left:55%;animation-delay:0.9s;"></div>
      </div>

      <!-- Radiation symbol (decorative) -->
      <svg class="radiation-symbol" viewBox="0 0 100 100" style="top:8%;right:5%;">
        <circle cx="50" cy="50" r="8" fill="none" stroke="#FFC107" stroke-width="3"/>
        <path d="M50 42 L40 15 A35 35 0 0 1 60 15 Z" fill="#FFC107"/>
        <path d="M56 48 L80 35 A35 35 0 0 1 70 62 Z" fill="#FFC107"/>
        <path d="M44 56 L20 62 A35 35 0 0 1 30 35 Z" fill="#FFC107"/>
      </svg>

      <div class="whistle-effect" id="whistle">BEER BREAK!</div>

      <!-- HOMER (main character) -->
      <div class="character main-char" data-character="homer" style="right:20%;bottom:18%;" id="char-homer-plant">
        <div class="char-body">
          <div class="char-head">
            <div class="char-cap"></div>
            <div class="char-goatee"></div>
            <div class="char-eyes">
              <div class="char-eye"><div class="char-pupil"></div></div>
              <div class="char-eye"><div class="char-pupil"></div></div>
            </div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs">
            <div class="char-leg"></div>
            <div class="char-leg"></div>
          </div>
        </div>
        <div class="char-label">"KENTER"</div>
      </div>

      <!-- Mr. Burns NPC (Right of Homer, Right-facing) -->
      <div class="character npc-char" data-npc="burns" style="right:12%;bottom:12%;--head-size:2.6vw;transform:scaleX(-1);">
        <div class="char-body">
          <div class="char-head">
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
      </div>

      <!-- Mr. Smithers NPC (Right of Burns, Left-facing) -->
      <div class="character npc-char" data-npc="smithers" style="right:4%;bottom:12%;--head-size:2.8vw;">
        <div class="char-body">
          <div class="char-head">
            <div class="char-glasses"></div>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCENE 5: MARGE — GROCERY -->
  <div class="scene" id="scene-marge">
    <div class="store-interior">
      <div class="store-shelf" style="left:5%;">
        <div class="shelf-item" style="top:10%;background:#E74C3C;"></div>
        <div class="shelf-item" style="top:28%;background:#3498DB;"></div>
        <div class="shelf-item" style="top:46%;background:#F39C12;"></div>
        <div class="shelf-item" style="top:64%;background:#2ECC71;"></div>
        <div class="shelf-item" style="top:82%;background:#9B59B6;"></div>
      </div>
      <div class="store-shelf" style="left:16%;">
        <div class="shelf-item" style="top:10%;background:#1ABC9C;"></div>
        <div class="shelf-item" style="top:28%;background:#E67E22;"></div>
        <div class="shelf-item" style="top:46%;background:#E74C3C;"></div>
        <div class="shelf-item" style="top:64%;background:#3498DB;"></div>
        <div class="shelf-item" style="top:82%;background:#F1C40F;"></div>
      </div>

      <div class="checkout-belt"></div>
      <div class="grocery-item" style="bottom:24%;left:38%;background:#E74C3C;"></div>
      <div class="grocery-item" style="bottom:24%;left:45%;background:#27AE60;"></div>
      <div class="grocery-item" style="bottom:24%;left:52%;background:#F39C12;"></div>

      <!-- MARGE (main character) -->
      <div class="character main-char" data-character="marge" style="right:25%;bottom:12%;" id="char-marge-store">
        <div class="char-body">
          <div class="char-head">
            <div class="char-hair-tall"></div>
            <div class="char-glasses"></div>
            <div class="char-eyes">
              <div class="char-eye"><div class="char-pupil"></div></div>
              <div class="char-eye"><div class="char-pupil"></div></div>
            </div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs">
            <div class="char-leg"></div>
            <div class="char-leg"></div>
          </div>
        </div>
        <div class="char-label">"MELSA"</div>
      </div>

      <!-- NPC: Cashier -->
      <div class="character npc-char" style="left:62%;bottom:15%;--head-size:2.8vw;">
        <div class="char-body">
          <div class="char-head" style="background:var(--npc-skin);">
            <div class="char-eyes">
              <div class="char-eye"><div class="char-pupil"></div></div>
              <div class="char-eye"><div class="char-pupil"></div></div>
            </div>
          </div>
          <div class="char-torso" style="background:#E74C3C;"></div>
          <div class="char-legs">
            <div class="char-leg" style="background:#34495E;"></div>
            <div class="char-leg" style="background:#34495E;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCENE 6: RELATIVE 1 — PERFORMANCE SCENE -->
  <div class="scene" id="scene-relative1">
    <div class="spotlight"></div>
    <div class="music-notes" id="music-notes"></div>

    <!-- Stage floor -->
    <div style="position:absolute;bottom:0;width:100%;height:25%;background:linear-gradient(180deg,#3E2723,#4E342E);border-top:4px solid #5D4037;"></div>

    <!-- RELATIVE 1 (main character) -->
    <div class="character main-char" data-character="relative1" style="left:50%;bottom:25%;transform:translateX(-50%);" id="char-relative1">
      <div class="char-body">
        <div class="char-head">
          <div class="char-hair"></div>
          <div class="char-eyes">
            <div class="char-eye"><div class="char-pupil"></div></div>
            <div class="char-eye"><div class="char-pupil"></div></div>
          </div>
          <div class="char-image-slot"></div>
        </div>
        <div class="char-torso">
          <div class="prop-recorder"></div>
        </div>
        <div class="char-legs">
          <div class="char-leg"></div>
          <div class="char-leg"></div>
        </div>
      </div>
      <div class="char-label">CRAZY UNCLE</div>
    </div>

    <!-- NPC: Audience silhouettes -->
    <div style="position:absolute;bottom:0;width:100%;height:12%;display:flex;justify-content:center;gap:1vw;opacity:0.4;">
      <div style="width:3vw;height:100%;background:#111;border-radius:50% 50% 0 0;"></div>
      <div style="width:3vw;height:90%;background:#111;border-radius:50% 50% 0 0;align-self:flex-end;"></div>
      <div style="width:3vw;height:100%;background:#111;border-radius:50% 50% 0 0;"></div>
      <div style="width:3vw;height:85%;background:#111;border-radius:50% 50% 0 0;align-self:flex-end;"></div>
      <div style="width:3vw;height:100%;background:#111;border-radius:50% 50% 0 0;"></div>
      <div style="width:3vw;height:95%;background:#111;border-radius:50% 50% 0 0;align-self:flex-end;"></div>
      <div style="width:3vw;height:100%;background:#111;border-radius:50% 50% 0 0;"></div>
    </div>
  </div>

  <!-- SCENE 7: RELATIVE 2 — OUTDOOR ACTIVITY -->
  <div class="scene" id="scene-relative2">
    <div class="sports-field"></div>
    <div class="field-lines"></div>

    <!-- Goalposts -->
    <div style="position:absolute;bottom:50%;right:8%;width:0.5vw;height:15%;background:white;"></div>
    <div style="position:absolute;bottom:62%;right:5%;width:7vw;height:0.5vw;background:white;"></div>
    <div style="position:absolute;bottom:50%;right:12%;width:0.5vw;height:15%;background:white;"></div>

    <!-- Sun -->
    <div style="position:absolute;top:8%;left:12%;width:6vw;height:6vw;background:radial-gradient(circle,#FFF176 30%,#FDD835 60%,transparent 70%);border-radius:50%;"></div>

    <!-- RELATIVE 2 (main character) -->
    <div class="character main-char" data-character="relative2" style="left:35%;bottom:50%;" id="char-relative2">
      <div class="char-body">
        <div class="char-head">
          <div class="char-hair"></div>
          <div class="char-eyes">
            <div class="char-eye"><div class="char-pupil"></div></div>
            <div class="char-eye"><div class="char-pupil"></div></div>
          </div>
          <div class="char-image-slot"></div>
        </div>
        <div class="char-torso"></div>
        <div class="char-legs">
          <div class="char-leg"></div>
          <div class="char-leg"></div>
        </div>
      </div>
      <div class="char-label">BIRTHDAY GUY</div>
    </div>

    <!-- BART (replacing NPCs) -->
    <div class="character main-char" data-character="bart" style="left:60%;bottom:50%;" id="char-bart-sports">
      <div class="char-body">
        <div class="char-head">
          <svg class="char-spikes" viewBox="0 0 50 25" style="position:absolute;top:-30%;left:5%;width:90%;z-index:3;">
            <polygon points="5,25 10,2 15,25 20,5 25,25 30,2 35,25 40,5 45,25" fill="var(--simpsons-yellow)" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
          </svg>
          <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
          <div class="char-image-slot"></div>
        </div>
        <div class="char-torso"></div>
        <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
      </div>
      <div class="char-label">"NART"</div>
    </div>
  </div>

  <!-- SCENE 8: DRIVE HOME -->
  <div class="scene" id="scene-drive">
    <div class="road-lines"></div>

    <!-- Sidewalk NPC townspeople -->
    <div class="character npc-char npc-townsperson" style="left:15%;--head-size:2.2vw;">
      <div class="char-body">
        <div class="char-head" style="background:var(--npc-skin);"><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div></div>
        <div class="char-torso" style="background:#9C27B0;"></div>
        <div class="char-legs"><div class="char-leg" style="background:#333;"></div><div class="char-leg" style="background:#333;"></div></div>
      </div>
    </div>
    <div class="character npc-char npc-townsperson" style="left:30%;--head-size:2.5vw;">
      <div class="char-body">
        <div class="char-head" style="background:var(--npc-skin);"><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div></div>
        <div class="char-torso" style="background:#FF9800;"></div>
        <div class="char-legs"><div class="char-leg" style="background:#795548;"></div><div class="char-leg" style="background:#795548;"></div></div>
      </div>
    </div>
    <div class="character npc-char npc-townsperson" style="left:75%;--head-size:2vw;">
      <div class="char-body">
        <div class="char-head" style="background:var(--npc-skin);"><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div></div>
        <div class="char-torso" style="background:#4CAF50;"></div>
        <div class="char-legs"><div class="char-leg" style="background:#333;"></div><div class="char-leg" style="background:#333;"></div></div>
      </div>
    </div>

    <!-- Family car driving -->
    <div class="car" id="family-car" style="left:-20vw;">
      <div class="car-top">
        <div class="car-window front"></div>
        <div class="car-window back"></div>
      </div>
      <div class="car-body"></div>
      <div class="car-wheel front-wheel"></div>
      <div class="car-wheel back-wheel"></div>
    </div>

    <!-- Buildings in background -->
    <div style="position:absolute;top:0;left:0;width:100%;height:40%;display:flex;align-items:flex-end;gap:1.5%;padding:0 3%;">
      <div style="width:12%;height:60%;background:var(--building-beige);border-radius:3px 3px 0 0;"></div>
      <div style="width:8%;height:80%;background:var(--building-pink);border-radius:3px 3px 0 0;"></div>
      <div style="width:15%;height:50%;background:var(--building-blue);border-radius:3px 3px 0 0;"></div>
      <div style="width:6%;height:90%;background:#B0BEC5;border-radius:3px 3px 0 0;"></div>
      <div style="width:10%;height:45%;background:var(--building-beige);border-radius:3px 3px 0 0;"></div>
      <div style="width:14%;height:70%;background:var(--building-pink);border-radius:3px 3px 0 0;"></div>
      <div style="width:9%;height:55%;background:#A5D6A7;border-radius:3px 3px 0 0;"></div>
      <div style="width:12%;height:85%;background:var(--building-blue);border-radius:3px 3px 0 0;"></div>
    </div>
  </div>

  <!-- SCENE 9: COUCH GAG -->
  <div class="scene" id="scene-couch">
    <div class="living-room">
      <div class="tv-painting"></div>

      <div class="lamp" style="left:8%;">
        <div class="lamp-shade"></div>
        <div class="lamp-stand"></div>
        <div class="lamp-base"></div>
      </div>
      <div class="lamp" style="right:8%;">
        <div class="lamp-shade"></div>
        <div class="lamp-stand"></div>
        <div class="lamp-base"></div>
      </div>

      <div class="floor-area"></div>

      <div class="couch" id="the-couch">
        <div class="couch-arm left"></div>
        <div class="couch-back"></div>
        <div class="couch-seat"></div>
        <div class="couch-arm right"></div>
      </div>

      <!-- Couch characters L→R: Bart, Relative2, Marge, Homer, Relative1 -->
      <div class="character main-char couch-character" data-character="bart" style="left:20%;" id="couch-bart">
        <div class="char-body">
          <div class="char-head">
            <svg class="char-spikes" viewBox="0 0 50 25" style="position:absolute;top:-30%;left:5%;width:90%;z-index:3;">
              <polygon points="5,25 10,2 15,25 20,5 25,25 30,2 35,25 40,5 45,25" fill="var(--simpsons-yellow)" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
            </svg>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div><div class="char-image-slot"></div></div>
          <div class="char-torso"></div>
        </div>
      </div>
      <div class="character main-char couch-character" data-character="relative2" style="left:32%;" id="couch-rel2">
        <div class="char-body">
          <div class="char-head"><div class="char-hair"></div><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div><div class="char-image-slot"></div></div>
          <div class="char-torso"></div>
        </div>
      </div>
      <div class="character main-char couch-character" data-character="marge" style="left:44%;" id="couch-marge">
        <div class="char-body">
          <div class="char-head"><div class="char-hair-tall"></div><div class="char-glasses"></div><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div><div class="char-image-slot"></div></div>
          <div class="char-torso"></div>
        </div>
      </div>
      <div class="character main-char couch-character" data-character="homer" style="left:56%;" id="couch-homer">
        <div class="char-body">
          <div class="char-head"><div class="char-cap"></div><div class="char-goatee"></div><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div><div class="char-image-slot"></div></div>
          <div class="char-torso"></div>
        </div>
      </div>
      <div class="character main-char couch-character" data-character="relative1" style="left:68%;" id="couch-rel1">
        <div class="char-body">
          <div class="char-head"><div class="char-hair"></div><div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div><div class="char-image-slot"></div></div>
          <div class="char-torso"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCENE 10: BIRTHDAY — RELATIVE 2 -->
  <div class="scene no-interaction" id="scene-birthday">
    <!-- Room background -->
    <div class="birthday-room">
      <!-- Banner -->
      <div class="birthday-banner" id="birthday-banner">
        <span>H</span><span>A</span><span>P</span><span>P</span><span>Y</span>
        <span class="banner-space"></span>
        <span>B</span><span>I</span><span>R</span><span>T</span><span>H</span><span>D</span><span>A</span><span>Y</span><span>!</span>
      </div>

      <!-- Balloons -->
      <div class="balloon-cluster" id="balloon-cluster">
        <div class="balloon" style="left:8%;background:#E74C3C;animation-delay:0s;"></div>
        <div class="balloon" style="left:15%;background:#3498DB;animation-delay:0.3s;"></div>
        <div class="balloon" style="left:22%;background:#F39C12;animation-delay:0.6s;"></div>
        <div class="balloon" style="left:72%;background:#9B59B6;animation-delay:0.2s;"></div>
        <div class="balloon" style="left:80%;background:#2ECC71;animation-delay:0.5s;"></div>
        <div class="balloon" style="left:88%;background:#E74C3C;animation-delay:0.8s;"></div>
      </div>

      <!-- Table with cake -->
      <div class="birthday-table">
        <div class="birthday-cake" id="birthday-cake">
          <div class="cake-layer cake-bottom"></div>
          <div class="cake-layer cake-middle"></div>
          <div class="cake-layer cake-top"></div>
          <div class="cake-candles" id="cake-candles"></div>
          <div class="cake-glow" id="cake-glow"></div>
        </div>
      </div>

      <!-- Floor -->
      <div class="birthday-floor"></div>

      <!-- Confetti container -->
      <div class="confetti-container" id="confetti-container"></div>

      <!-- RELATIVE 2: Birthday person (center, slightly forward) -->
      <div class="character main-char birthday-char tooltip-target" data-character="relative2" style="left:50%;bottom:22%;transform:translateX(-50%);z-index:15;" id="bday-relative2">
        <div class="tooltip-box">Birthday Guy</div>
        <div class="char-body">
          <div class="char-head">
            <!-- Party hat placeholder -->
            <div class="party-hat" style="border-bottom-color:#E74C3C;"></div>
            <div class="char-hair"></div>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
        <div class="char-label">🎂 BIRTHDAY GUY</div>
      </div>

      <!-- BART: Far left, holding a present -->
      <div class="character main-char birthday-char" data-character="bart" style="left:12%;bottom:22%;z-index:12;" id="bday-bart">
        <div class="char-body">
          <div class="char-head">
            <svg class="char-spikes" viewBox="0 0 50 25" style="position:absolute;top:-30%;left:5%;width:90%;z-index:3;">
              <polygon points="5,25 10,2 15,25 20,5 25,25 30,2 35,25 40,5 45,25" fill="var(--simpsons-yellow)" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
            </svg>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
        <!-- Present prop -->
        <div class="present-box" style="position:absolute;bottom:30%;right:-40%;"></div>
      </div>

      <!-- MARGE: Left-center -->
      <div class="character main-char birthday-char" data-character="marge" style="left:30%;bottom:22%;z-index:13;" id="bday-marge">
        <div class="char-body">
          <div class="char-head">
            <div class="char-hair-tall"></div>
            <div class="char-glasses"></div>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso"></div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
      </div>

      <!-- HOMER: Right-center -->
      <div class="character main-char birthday-char" data-character="homer" style="left:66%;bottom:22%;z-index:13;" id="bday-homer">
        <div class="char-body">
          <div class="char-head">
            <div class="char-cap"></div>
            <div class="char-goatee"></div>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso">
            <!-- Vinyl Record Prop -->
            <div class="prop-vinyl-sleeve tooltip-target">
              <div class="prop-vinyl-record"></div>
              <div class="tooltip-box">
                Classic Hit Album!
                <a href="https://distrokid.com/hyperfollow/yrwh/why-are-we-here" target="_blank">Listen Now</a>
              </div>
            </div>
          </div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
      </div>

      <!-- RELATIVE 1: Far right -->
      <div class="character main-char birthday-char" data-character="relative1" style="left:82%;bottom:22%;z-index:12;" id="bday-relative1">
        <div class="char-body">
          <div class="char-head">
            <div class="char-hair"></div>
            <div class="char-eyes"><div class="char-eye"><div class="char-pupil"></div></div><div class="char-eye"><div class="char-pupil"></div></div></div>
            <div class="char-image-slot"></div>
          </div>
          <div class="char-torso">
             <!-- Coffee Mug Prop -->
             <div class="prop-mug tooltip-target">
               <div class="tooltip-box">
                 Iconic Coffee Mug
                 <img src="mug-placeholder.jpg" alt="Mug">
               </div>
             </div>
          </div>
          <div class="char-legs"><div class="char-leg"></div><div class="char-leg"></div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="bg-music" src="theme.mp3" preload="auto"></audio>

<!-- CONTROLS -->
<div id="play-overlay" style="display:flex;">
  <div id="loading-msg" style="color:var(--simpsons-yellow); font-family:'Chewy'; font-size:2rem;">LOADING...</div>
  <button id="play-btn" style="display:none;">▶ PLAY INTRO</button>
</div>

<script>
// ===== INTRO ANIMATION ENGINE =====
// Durations specified: 6, 6, 8, 6, 8, 8, 12, 12, 6, 10
const SCENES = [
  { id: 'scene-title',     label: 'TITLE',        duration: 6000,  setup: setupTitle },
  { id: 'scene-flyover',   label: 'FLYOVER',      duration: 6000,  setup: setupFlyover },
  { id: 'scene-bart',      label: 'BART',         duration: 8000,  setup: setupBart },
  { id: 'scene-homer',     label: 'HOMER',        duration: 8000,  setup: setupHomer },
  { id: 'scene-marge',     label: 'MARGE',        duration: 10000,  setup: setupMarge },
  { id: 'scene-relative1', label: 'RELATIVE 1',   duration: 8000,  setup: setupRelative1 },
  { id: 'scene-relative2', label: 'RELATIVE 2',   duration: 12000, setup: setupRelative2 },
  { id: 'scene-drive',     label: 'DRIVE HOME',   duration: 12000, setup: setupDrive },
  { id: 'scene-couch',     label: 'COUCH GAG',    duration: 6000,  setup: setupCouch },
  { id: 'scene-birthday',  label: 'BIRTHDAY',     duration: 10000, setup: setupBirthday },
];

let currentScene = 0;
let autoTimer = null;
let isPlaying = false;

// Audio Preload Logic
const audio = document.getElementById('bg-music');
audio.addEventListener('canplaythrough', () => {
  document.getElementById('loading-msg').style.display = 'none';
  document.getElementById('play-btn').style.display = 'block';
});
// Fallback if event already fired or cached
if (audio.readyState >= 4) {
  document.getElementById('loading-msg').style.display = 'none';
  document.getElementById('play-btn').style.display = 'block';
}

function startIntro() {
  document.getElementById('play-overlay').style.display = 'none';
  audio.currentTime = 0;
  audio.play().catch(e => console.log('Audio playback failed', e));
  
  isPlaying = true;
  currentScene = 0;
  showScene(0, false);
  advanceAuto();
}

function showScene(index, withWipe = true) {
  if (index < 0 || index >= SCENES.length) return;

  const wipe = document.getElementById('wipe');

  const doTransition = () => {
    // Hide all scenes
    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));

    // Show target
    const target = document.getElementById(SCENES[index].id);
    target.classList.add('active');
    currentScene = index;

    // Run scene setup
    if (SCENES[index].setup) SCENES[index].setup();
  };

  if (withWipe && index !== 0) {
    wipe.classList.remove('active');
    void wipe.offsetWidth; // force reflow
    wipe.classList.add('active');
    setTimeout(doTransition, 280);
  } else {
    doTransition();
  }
}

function advanceAuto() {
  if (!isPlaying) return;
  const dur = SCENES[currentScene].duration;
  autoTimer = setTimeout(() => {
    if (currentScene < SCENES.length - 1) {
      showScene(currentScene + 1);
      advanceAuto();
    } else {
      // Scene 10 ended - Enter Floating State
      enterFloatingState();
    }
  }, dur);
}

function enterFloatingState() {
  isPlaying = false;
  clearTimeout(autoTimer);
  // Enable interaction
  document.getElementById('scene-birthday').classList.remove('no-interaction');
  // No overlay shown, just floating state
  console.log("Entered Floating State");
}

function stopAuto() {
  isPlaying = false;
  clearTimeout(autoTimer);
  document.getElementById('play-overlay').style.display = 'flex';
  document.getElementById('play-btn').textContent = '↺ REPLAY';
  document.getElementById('bg-music').pause();
}


// ===== SCENE SETUP FUNCTIONS =====

function setupTitle() {
  const title = document.getElementById('main-title');
  const sub = document.getElementById('sub-title');
  const left = document.getElementById('clouds-left');
  const right = document.getElementById('clouds-right');

  // Reset
  title.classList.remove('animate-in');
  sub.classList.remove('animate-in');
  left.classList.remove('clouds-parting-left');
  right.classList.remove('clouds-parting-right');
  void title.offsetWidth;

  // Trigger
  left.classList.add('clouds-parting-left');
  right.classList.add('clouds-parting-right');
  title.classList.add('animate-in');
  sub.classList.add('animate-in');
}

function setupFlyover() {
  const panorama = document.getElementById('panorama');
  // Reset animation
  panorama.style.animation = 'none';
  void panorama.offsetWidth;
  panorama.style.animation = 'panoramaScroll 5s linear forwards';

  // Generate buildings if empty
  if (panorama.children.length === 0) {
    const colors = ['#D4A574','#E8A0BF','#7EB8D4','#A5D6A7','#FFCC80','#CE93D8','#90CAF9','#FFAB91'];
    for (let i = 0; i < 25; i++) {
      const b = document.createElement('div');
      b.className = 'building';
      const h = 30 + Math.random() * 55;
      const w = 3 + Math.random() * 5;
      b.style.cssText = `
        left:${i * 4}%;
        width:${w}%;
        height:${h}%;
        background:${colors[i % colors.length]};
      `;
      // Add windows
      const winCount = Math.floor(h / 15);
      for (let j = 0; j < winCount; j++) {
        for (let k = 0; k < 2; k++) {
          const win = document.createElement('div');
          win.className = 'building-window';
          win.style.cssText = `top:${10 + j * 18}%;left:${15 + k * 50}%;`;
          b.appendChild(win);
        }
      }
      panorama.appendChild(b);
    }

    // Nuclear towers
    const t1 = document.createElement('div');
    t1.className = 'nuclear-tower';
    t1.style.cssText = 'left:75%;height:65%;';
    panorama.appendChild(t1);

    const t2 = document.createElement('div');
    t2.className = 'nuclear-tower';
    t2.style.cssText = 'left:82%;height:55%;';
    panorama.appendChild(t2);
  }
}

function setupBart() {
  const chalk = document.getElementById('chalk-text');
  chalk.classList.remove('writing');
  chalk.style.opacity = '0';
  void chalk.offsetWidth;
  chalk.classList.add('writing');

  // Show label briefly
  const bart = document.getElementById('char-bart-classroom');
  bart.classList.add('show-label');
  setTimeout(() => bart.classList.remove('show-label'), 2500);
}

function setupHomer() {
  const whistle = document.getElementById('whistle');
  whistle.classList.remove('show');
  void whistle.offsetWidth;
  setTimeout(() => whistle.classList.add('show'), 1200);

  const homer = document.getElementById('char-homer-plant');
  homer.classList.add('show-label');
  setTimeout(() => homer.classList.remove('show-label'), 3000);
}

function setupMarge() {
  const marge = document.getElementById('char-marge-store');
  marge.classList.add('show-label');
  setTimeout(() => marge.classList.remove('show-label'), 2500);
}

function setupRelative1() {
  const notesContainer = document.getElementById('music-notes');
  notesContainer.innerHTML = '';
  const notes = ['♪', '♫', '♬', '♩', '𝅘𝅥𝅮'];
  for (let i = 0; i < 12; i++) {
    const n = document.createElement('div');
    n.className = 'note';
    n.textContent = notes[i % notes.length];
    n.style.cssText = `
      left:${30 + Math.random() * 40}%;
      bottom:${25 + Math.random() * 15}%;
      animation-delay:${i * 0.35}s;
      color:hsl(${40 + Math.random() * 40}, 90%, 70%);
    `;
    notesContainer.appendChild(n);
  }

  const rel1 = document.getElementById('char-relative1');
  rel1.classList.add('show-label');
  setTimeout(() => rel1.classList.remove('show-label'), 3000);
}

function setupRelative2() {
  const rel2 = document.getElementById('char-relative2');
  rel2.classList.add('show-label');
  setTimeout(() => rel2.classList.remove('show-label'), 2500);
}

function setupDrive() {
  const car = document.getElementById('family-car');
  car.style.transition = 'none';
  car.style.left = '-20vw';
  void car.offsetWidth;
  car.style.transition = 'left 3.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  car.style.left = '35vw';
}

function setupCouch() {
  // Arrival order matches L→R seating: Bart, Rel2, Marge, Homer, Rel1
  const chars = [
    'couch-bart',
    'couch-rel2',
    'couch-marge',
    'couch-homer',
    'couch-rel1'
  ];

  chars.forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('arrive');
    el.style.opacity = '0';
  });

  chars.forEach((id, i) => {
    setTimeout(() => {
      const el = document.getElementById(id);
      el.style.opacity = '';
      el.classList.add('arrive');
    }, 600 + i * 400);
  });
}

function setupBirthday() {
  // Reset all birthday elements
  const banner = document.getElementById('birthday-banner');
  banner.classList.remove('reveal');

  const balloons = document.querySelectorAll('#scene-birthday .balloon');
  balloons.forEach(b => b.classList.remove('float-in'));

  const bdayChars = document.querySelectorAll('#scene-birthday .birthday-char');
  bdayChars.forEach(c => { c.classList.remove('appear'); c.style.opacity = '0'; });

  const confettiContainer = document.getElementById('confetti-container');
  confettiContainer.innerHTML = '';

  const cakeCandles = document.getElementById('cake-candles');
  const cakeGlow = document.getElementById('cake-glow');
  cakeGlow.classList.remove('active');
  cakeCandles.innerHTML = '';

  // Build candles
  const candleColors = ['#E74C3C','#3498DB','#F39C12','#2ECC71','#9B59B6'];
  for (let i = 0; i < 5; i++) {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'center';

    const flame = document.createElement('div');
    flame.className = 'candle-flame';
    flame.id = `flame-${i}`;

    const candle = document.createElement('div');
    candle.className = 'candle';
    candle.style.background = candleColors[i];

    wrapper.appendChild(flame);
    wrapper.appendChild(candle);
    cakeCandles.appendChild(wrapper);
  }

  void banner.offsetWidth;

  // Sequence:
  // 0ms: Banner reveals letter by letter
  const bannerSpans = banner.querySelectorAll('span');
  bannerSpans.forEach((s, i) => { s.style.animationDelay = `${i * 0.06}s`; });
  banner.classList.add('reveal');

  // 400ms: Balloons float in
  setTimeout(() => {
    balloons.forEach(b => b.classList.add('float-in'));
  }, 400);

  // 900ms: Characters appear (surrounding ones first, birthday person last)
  const charOrder = ['bday-bart','bday-marge','bday-homer','bday-relative1','bday-relative2'];
  charOrder.forEach((id, i) => {
    setTimeout(() => {
      const el = document.getElementById(id);
      el.style.opacity = '';
      el.classList.add('appear');
      // Show label for birthday person
      if (id === 'bday-relative2') el.classList.add('show-label');
    }, 900 + i * 350);
  });

  // 2800ms: Candles light up + glow
  setTimeout(() => {
    cakeGlow.classList.add('active');
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        document.getElementById(`flame-${i}`).classList.add('lit');
      }, i * 150);
    }
  }, 2800);

  // 4000ms: Confetti burst
  setTimeout(() => {
    const colors = ['#E74C3C','#3498DB','#F39C12','#2ECC71','#9B59B6','#F1C40F','#E91E63','#00BCD4'];
    for (let i = 0; i < 60; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.left = `${10 + Math.random() * 80}%`;
      piece.style.top = `${-5 + Math.random() * 10}%`;
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDelay = `${Math.random() * 1.5}s`;
      piece.style.width = `${0.3 + Math.random() * 0.6}vw`;
      piece.style.height = `${0.3 + Math.random() * 0.6}vw`;
      piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '1px';
      confettiContainer.appendChild(piece);
      setTimeout(() => piece.classList.add('fall'), 50);
    }
  }, 4000);
}

// ===== CHARACTER IMAGE SWAP API =====
/*
  To swap in custom character images later, call:

  setCharacterImage('homer', 'path/to/homer.png');
  setCharacterImage('marge', 'path/to/marge.png');
  setCharacterImage('bart', 'path/to/bart.png');
  setCharacterImage('relative1', 'path/to/rel1.png');
  setCharacterImage('relative2', 'path/to/rel2.png');

  This will show the custom image over the generic silhouette
  for ALL instances of that character across all scenes.
*/
function setCharacterImage(characterName, imageUrl) {
  const chars = document.querySelectorAll(`[data-character="${characterName}"]`);
  chars.forEach(el => {
    const slots = el.querySelectorAll('.char-image-slot');
    slots.forEach(slot => {
      slot.style.display = 'block';
      slot.innerHTML = `<img src="${imageUrl}" alt="${characterName}">`;
    });
  });
}

// Expose globally
window.setCharacterImage = setCharacterImage;

// ===== EVENT LISTENERS =====
document.getElementById('play-btn').addEventListener('click', startIntro);

// Keyboard
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { 
    if(document.getElementById('play-overlay').style.display !== 'none') {
        startIntro();
    }
  }
});

// ===== INIT =====
// Wait for play
</script>
</body>
</html>
