CREATE OR REPLACE FUNCTION get_leaderboard()
RETURNS TABLE(user_id uuid, email text, max_score bigint) AS $$
BEGIN
  RETURN QUERY
  SELECT
    u.id as user_id,
    u.email,
    MAX(qr.score) as max_score
  FROM
    public.quiz_results qr
  JOIN
    auth.users u ON qr.user_id = u.id
  GROUP BY
    u.id, u.email
  ORDER BY
    max_score DESC
  LIMIT 10;
END;
$$ LANGUAGE plpgsql;
