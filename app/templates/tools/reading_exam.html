{% extends "base.html" %}

{% block title %}NP-simulatorn: L칛sf칬rst친else{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title">NP-simulatorn: L칛sf칬rst친else 游닀</h2>
            <p class="card-text">Klistra in en text nedan f칬r att generera och 칬va p친 l칛sf칬rst친elsefr친gor i stil med Nationella Proven.</p>

            <div class="form-group mb-3">
                <textarea id="text-input" class="form-control" rows="10" placeholder="Klistra in din text h칛r..."></textarea>
            </div>
            <button id="generate-exam-btn" class="btn btn-primary">Generera prov</button>
            <div id="spinner" class="spinner-border text-primary ms-2" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div id="exam-container" class="mt-4"></div>
    <div id="feedback-container" class="mt-4"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const generateBtn = document.getElementById('generate-exam-btn');
        const textInput = document.getElementById('text-input');
        const examContainer = document.getElementById('exam-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const spinner = document.getElementById('spinner');

        let correctAnswers = [];

        generateBtn.addEventListener('click', async () => {
            const text = textInput.value;
            if (!text.trim()) {
                alert('V칛nligen klistra in en text.');
                return;
            }

            spinner.style.display = 'inline-block';
            examContainer.innerHTML = '';
            feedbackContainer.innerHTML = '';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/tools/reading-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    examContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                correctAnswers = data.questions.map(q => q.correct_answer);
                renderExam(data.questions);

            } catch (error) {
                console.error('Error fetching exam:', error);
                examContainer.innerHTML = `<div class="alert alert-danger">Ett fel uppstod. F칬rs칬k igen.</div>`;
            } finally {
                spinner.style.display = 'none';
                generateBtn.disabled = false;
            }
        });

        function renderExam(questions) {
            let examHTML = '<form id="exam-form">';
            questions.forEach((q, index) => {
                examHTML += `
                    <div class="card mb-3" id="question-card-${index}">
                        <div class="card-body">
                            <p class="fw-bold">${index + 1}. ${q.question_text}</p>`;

                if (q.type === 'multiple-choice') {
                    q.options.forEach((option, optionIndex) => {
                        examHTML += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question-${index}" id="q-${index}-o-${optionIndex}" value="${option}">
                                <label class="form-check-label" for="q-${index}-o-${optionIndex}">${option}</label>
                            </div>`;
                    });
                } else if (q.type === 'open-ended') {
                    examHTML += `<textarea class="form-control" name="question-${index}" rows="4" placeholder="Skriv ditt svar h칛r..."></textarea>`;
                }
                
                // Div to show feedback
                examHTML += `<div id="feedback-${index}" class="mt-2"></div>`;
                examHTML += `</div></div>`;
            });
            examHTML += `</form><button id="grade-btn" class="btn btn-success mt-3">R칛tta provet</button>`;
            examContainer.innerHTML = examHTML;

            // Add event listener to the newly created grade button
            document.getElementById('grade-btn').addEventListener('click', gradeExam);
        }

        function gradeExam() {
            const form = document.getElementById('exam-form');
            let score = 0;
            correctAnswers.forEach((answer, index) => {
                const card = document.getElementById(`question-card-${index}`);
                const feedbackDiv = document.getElementById(`feedback-${index}`);
                const userInput = form.elements[`question-${index}`];
                let userAnswer = '';
                
                // Reset styling
                card.classList.remove('border-success', 'border-danger');
                
                if (userInput.type === 'textarea') { // Open-ended
                    userAnswer = userInput.value.trim();
                    feedbackDiv.innerHTML = `<div class="alert alert-info"><b>Modellsvar:</b> ${answer}</div>`;
                    // Open questions are not auto-graded for correctness, just shown the model answer.
                    card.classList.add('border-info');

                } else { // Multiple-choice
                    const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                    userAnswer = selectedOption ? selectedOption.value : null;

                    if (userAnswer === answer) {
                        score++;
                        card.classList.add('border-success');
                        feedbackDiv.innerHTML = `<div class="alert alert-success"><b>Korrekt!</b> R칛tt svar 칛r: ${answer}</div>`;
                    } else {
                        card.classList.add('border-danger');
                        feedbackDiv.innerHTML = `<div class="alert alert-danger"><b>Fel.</b> Du svarade "${userAnswer || 'Inget svar'}". R칛tt svar 칛r: ${answer}</div>`;
                    }
                }
            });
             document.getElementById('grade-btn').style.display = 'none'; // Hide button after grading
        }
    });
</script>
{% endblock %}