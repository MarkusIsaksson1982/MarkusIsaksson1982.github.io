{% extends "base.html" %}

{% block title %}Text-anpassningsverktyg{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Verktyg för textanpassning</h1>
    <p>Klistra in en text nedan, välj en målnivå (CEFR), och klicka på "Anpassa text". Verktyget kommer att generera en version av texten som är anpassad till den valda nivån.</p>

    <div class="card">
        <div class="card-body">
            <form id="modifier-form">
                <div class="mb-3">
                    <label for="text-input" class="form-label">Text att anpassa:</label>
                    <textarea class="form-control" id="text-input" rows="10" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="level-select" class="form-label">Målnivå (CEFR):</label>
                    <select class="form-select" id="level-select">
                        <option value="A2">A2 (Enklare)</option>
                        <option value="B1">B1</option>
                        <option value="B2">B2 (Original)</option>
                        <option value="C1">C1 (Mer avancerad)</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner" style="display: none;"></span>
                    Anpassa text
                </button>
            </form>
        </div>
    </div>

    <div id="result-container" class="mt-4" style="display: none;">
        <h2 class="mb-3">Resultat</h2>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Anpassad text</h5>
                <pre id="modified-text" style="white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('modifier-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const text = document.getElementById('text-input').value;
        const targetLevel = document.getElementById('level-select').value;
        
        // UI elements
        const resultContainer = document.getElementById('result-container');
        const modifiedTextEl = document.getElementById('modified-text');
        const submitButton = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');

        // --- Start loading state ---
        submitButton.disabled = true;
        spinner.style.display = 'inline-block';
        modifiedTextEl.textContent = 'Bearbetar...'; // Optional: show status text
        modifiedTextEl.className = 'text-muted'; // Use a different style for status text
        resultContainer.style.display = 'block';


        fetch('/tools/text-modifier', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text, target_level: targetLevel }),
        })
        .then(async response => {
            // We need to handle both successful and failed HTTP responses
            if (!response.ok) {
                // Try to parse error JSON from the server, but have a fallback
                const errorData = await response.json().catch(() => null);
                const errorMessage = errorData?.error || `Servern svarade med status ${response.status}.`;
                // Throw an error to be caught by the .catch() block
                throw new Error(errorMessage);
            }
            return response.json();
        })
        .then(data => {
            // Success case
            modifiedTextEl.className = ''; // Reset class
            modifiedTextEl.textContent = data.modified_text;
        })
        .catch(error => {
            // Failure case (network error or HTTP error from .then())
            console.error('Error:', error);
            modifiedTextEl.className = 'text-danger'; // Use a distinct error style
            modifiedTextEl.textContent = 'Ett fel uppstod: ' + error.message;
        })
        .finally(() => {
            // --- End loading state (this runs on success OR failure) ---
            submitButton.disabled = false;
            spinner.style.display = 'none';
        });
    });
</script>
{% endblock %}
