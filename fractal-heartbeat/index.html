<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fractal Heartbeat (Optimized)</title>
<style>
  body { margin:0; background:#000; height:100vh; display:flex; justify-content:center; align-items:center; }
  canvas { image-rendering: pixelated; }
  #info { position:absolute; top:10px; left:10px; color:#444; font-family:monospace; font-size:12px; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="info">Type to make the heart beat & grow fractals. Optimized for long sessions.</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 600;

let time = 0;
let bpm = 60;
let lastBeat = 0;
let pulse = 1;
let branches = []; // capped at 200

class Branch {
  constructor(x, y, angle, length, depth) {
    this.x = x | 0;
    this.y = y | 0;
    this.angle = angle;
    this.length = length;
    this.depth = depth;
    this.hue = (time % 360 + depth * 30) | 0;
  }
  draw() {
    const endX = (this.x + Math.cos(this.angle) * this.length * pulse) | 0;
    const endY = (this.y + Math.sin(this.angle) * this.length * pulse) | 0;
    ctx.strokeStyle = `hsl(${this.hue}, 80%, 60%)`;
    ctx.lineWidth = Math.max(1, 3 - this.depth * 0.2);
    ctx.beginPath();
    ctx.moveTo(this.x, this.y);
    ctx.lineTo(endX, endY);
    ctx.stroke();
  }
}

function drawHeart() {
  const cx = canvas.width / 2 | 0;
  const cy = canvas.height / 2 | 0;
  const size = 120 * pulse;

  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Heart shape
  ctx.beginPath();
  ctx.moveTo(cx, cy - size/2);
  ctx.bezierCurveTo(cx - size, cy - size, cx - size*1.5, cy, cx, cy + size);
  ctx.bezierCurveTo(cx + size*1.5, cy, cx + size, cy - size, cx, cy - size/2);
  ctx.closePath();
  ctx.fillStyle = `hsl(${time % 360}, 90%, 60%)`;
  ctx.fill();

  // Simple glow (fast)
  ctx.globalAlpha = 0.2;
  ctx.fillStyle = `hsl(${time % 360}, 90%, 70%)`;
  ctx.fillRect(cx - size, cy - size, size*2, size*2);
  ctx.globalAlpha = 1;

  // Draw branches
  branches.forEach(b => b.draw());
}

function animate() {
  time++;
  const now = performance.now();
  if (now - lastBeat > 60000 / bpm) {
    pulse = 1.3;
    lastBeat = now;

    // Add new branches sparingly
    branches.push(new Branch(canvas.width/2, canvas.height/2, Math.random()*Math.PI*2, 80, 0));

    // Hard cap to prevent growth
    if (branches.length > 200) branches.splice(0, branches.length - 200);
  }
  pulse = Math.max(1, pulse - 0.02);
  drawHeart();
  requestAnimationFrame(animate);
}

// BPM from keystrokes
document.addEventListener('keydown', () => {
  const now = performance.now();
  if (lastBeat > 0) {
    const interval = now - lastBeat;
    bpm = Math.max(40, Math.min(200, 60000 / interval));
  }
  lastBeat = now;
});

animate();
</script>
</body>
</html>
